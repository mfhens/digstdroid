# DK-AppStore GitLab CI/CD Pipeline
# Phase 0: Foundation

stages:
  - check
  - test
  - security
  - build
  - publish

variables:
  CARGO_HOME: ${CI_PROJECT_DIR}/.cargo
  RUSTFLAGS: "-D warnings"
  RUST_BACKTRACE: "1"

# Cache Cargo dependencies
.cargo-cache: &cargo-cache
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .cargo/
      - target/

# Base Rust job
.rust-base:
  image: rust:1.75
  <<: *cargo-cache
  before_script:
    - rustup component add clippy rustfmt
    - cargo --version
    - rustc --version

# Cache for Python/uv
.uv-cache: &uv-cache
  cache:
    key: ${CI_COMMIT_REF_SLUG}-python
    paths:
      - fdroid-bridge/.venv/

# Base Python job (using uv)
.python-base:
  image: python:3.11-slim
  <<: *uv-cache
  before_script:
    - apt-get update && apt-get install -y curl
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.cargo/bin:$PATH"
    - cd fdroid-bridge
    - uv sync

# =============================================================================
# CHECK STAGE - Fast feedback on code quality
# =============================================================================

format:
  extends: .rust-base
  stage: check
  script:
    - cargo fmt --all -- --check
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

lint:
  extends: .rust-base
  stage: check
  script:
    - cargo clippy --all-targets --all-features -- -D warnings
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# Check for common issues
check:
  extends: .rust-base
  stage: check
  script:
    - cargo check --all-targets --all-features
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# Python type checking (fdroid-bridge)
python-typecheck:
  extends: .python-base
  stage: check
  script:
    - uv run ty check
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - fdroid-bridge/**/*
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - fdroid-bridge/**/*
    - if: $CI_COMMIT_BRANCH == "develop"
      changes:
        - fdroid-bridge/**/*

# Python linting (fdroid-bridge)
python-lint:
  extends: .python-base
  stage: check
  script:
    - uv run ruff check .
    - uv run ruff format --check .
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - fdroid-bridge/**/*
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - fdroid-bridge/**/*
    - if: $CI_COMMIT_BRANCH == "develop"
      changes:
        - fdroid-bridge/**/*

# =============================================================================
# TEST STAGE
# =============================================================================

test:
  extends: .rust-base
  stage: test
  services:
    - postgres:16
    - redis:7
  variables:
    POSTGRES_DB: dk_appstore_test
    POSTGRES_USER: test
    POSTGRES_PASSWORD: test
    DATABASE_URL: postgres://test:test@postgres:5432/dk_appstore_test
    REDIS_URL: redis://redis:6379
  script:
    - cargo test --all-features --workspace
  coverage: '/^\d+\.\d+% coverage/'
  artifacts:
    reports:
      junit: target/nextest/ci/junit.xml
    when: always
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# Documentation tests
doc-test:
  extends: .rust-base
  stage: test
  script:
    - cargo test --doc --all-features
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# Python tests (fdroid-bridge)
python-test:
  extends: .python-base
  stage: test
  script:
    - uv run pytest --cov=fdroid_bridge --cov-report=xml
  coverage: '/TOTAL.*\s+(\d+%)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: fdroid-bridge/coverage.xml
    when: always
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - fdroid-bridge/**/*
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - fdroid-bridge/**/*
    - if: $CI_COMMIT_BRANCH == "develop"
      changes:
        - fdroid-bridge/**/*

# =============================================================================
# SECURITY STAGE
# =============================================================================

# Dependency vulnerability audit
audit:
  extends: .rust-base
  stage: security
  before_script:
    - cargo install cargo-audit
  script:
    - cargo audit
  allow_failure: false
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# License and dependency policy check
deny:
  extends: .rust-base
  stage: security
  before_script:
    - cargo install cargo-deny
  script:
    - cargo deny check
  allow_failure: false
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# Secret detection
secrets:
  stage: security
  image: zricethezav/gitleaks:latest
  script:
    - gitleaks detect --source . --verbose
  allow_failure: false
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# SAST (GitLab built-in)
sast:
  stage: security
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

include:
  - template: Security/SAST.gitlab-ci.yml

# =============================================================================
# BUILD STAGE
# =============================================================================

build-debug:
  extends: .rust-base
  stage: build
  script:
    - cargo build --all-features --workspace
  artifacts:
    paths:
      - target/debug/dk-api
    expire_in: 1 day
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

build-release:
  extends: .rust-base
  stage: build
  script:
    - cargo build --release --all-features --workspace
  artifacts:
    paths:
      - target/release/dk-api
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

# Build container image
container:
  stage: build
  image: 
    name: quay.io/podman/stable
    entrypoint: [""]
  script:
    - podman build -t dk-appstore/api:${CI_COMMIT_SHORT_SHA} -f server/Containerfile .
    - podman save dk-appstore/api:${CI_COMMIT_SHORT_SHA} -o api-image.tar
  artifacts:
    paths:
      - api-image.tar
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

# =============================================================================
# PUBLISH STAGE (Phase 1+)
# =============================================================================

# Placeholder for container registry push
# publish-container:
#   stage: publish
#   script:
#     - echo "Container publishing configured in Phase 1"
#   rules:
#     - if: $CI_COMMIT_TAG

# =============================================================================
# SCHEDULED JOBS
# =============================================================================

# Weekly full security audit
weekly-audit:
  extends: .rust-base
  stage: security
  before_script:
    - cargo install cargo-audit cargo-deny
  script:
    - cargo audit
    - cargo deny check
    - cargo update --dry-run
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  allow_failure: true
